---
phase: 04-arm-diagnostic-safety-nets
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/arm_strategies.c
  - src/arm_immediate_encoding.c
  - src/arm_immediate_encoding.h
  - assets/tests/test_arm_strategies.c
  - tests/fixtures/manifest.yaml
autonomous: true
requirements:
  - ARM-03
must_haves:
    truths:
      - ARM branch rewrite paths preserve target and fall-through semantics after instruction expansion.
      - Branch offset recalculation is correct for forward, backward, and boundary-sensitive covered cases.
      - Unsupported or unsafe branch forms decline rewrite deterministically without semantic mutation.
    artifacts:
      - path: src/arm_strategies.c
        provides: ARM branch rewrite strategy gating and generation with offset-safety checks
      - path: src/arm_immediate_encoding.c
        provides: ARM branch offset decode/encode helper behavior used by branch strategies
      - path: tests/fixtures/manifest.yaml
        provides: Deterministic ARM branch edge-case fixture metadata
    key_links:
      - from: src/arm_strategies.c
        to: src/arm_immediate_encoding.c
        via: Branch strategy generation relies on ARM branch offset helper APIs
        pattern: encode_arm_branch_instruction
      - from: assets/tests/test_arm_strategies.c
        to: src/arm_strategies.c
        via: Focused ARM tests validate branch rewrite semantics and safety decline behavior
        pattern: branch
      - from: tests/fixtures/manifest.yaml
        to: tests/run_tests.sh
        via: Deterministic ARM branch fixtures are selected by manifest-driven verification
        pattern: rep-arm
---

<objective>
Harden ARM branch offset recalculation and semantic safety for expanded rewrite paths.

Purpose: satisfy ARM-03 by ensuring branch target correctness after transformation growth.
Output: branch-safety helper coverage, strategy hardening, and deterministic branch edge-case fixtures/tests.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-arm-diagnostic-safety-nets/04-CONTEXT.md
@.planning/phases/04-arm-diagnostic-safety-nets/04-RESEARCH.md
@src/arm_strategies.c
@src/arm_immediate_encoding.c
@src/arm_immediate_encoding.h
@assets/tests/test_arm_strategies.c
@tests/fixtures/manifest.yaml

Locked decisions to honor:
- Branch correctness first; no new rewrite-family expansion.
- Deterministic fixture evidence is mandatory.
- Unsafe branch forms must decline rewrite safely.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add branch-offset safety helper coverage for expanded ARM rewrites</name>
  <files>src/arm_immediate_encoding.c
src/arm_immediate_encoding.h</files>
  <action>Add or refine helper behavior for branch offset decode/encode checks used by expanded ARM branch rewrites, including explicit guardrails for edge-case offset bounds and deterministic failure signaling.</action>
  <verify><automated>rg -n "branch|offset|decode_arm_branch_offset|encode_arm_branch_instruction|bounds" src/arm_immediate_encoding.c src/arm_immediate_encoding.h</automated></verify>
  <done>Branch helper APIs provide bounded, deterministic behavior for offset-safe branch transformations.</done>
</task>

<task type="auto">
  <name>Task 2: Harden ARM branch strategy generation with offset correctness contracts</name>
  <files>src/arm_strategies.c</files>
  <action>Update ARM branch rewrite strategy logic to preserve target/fall-through semantics under expanded output and to safely decline unsupported/high-risk cases with deterministic fallback behavior.</action>
  <verify><automated>rg -n "arm_branch|conditional_alt|can_handle|generate|offset|fallback" src/arm_strategies.c</automated></verify>
  <done>ARM branch rewrite strategies enforce explicit semantic-safety and offset-correctness contracts for covered cases.</done>
</task>

<task type="auto">
  <name>Task 3: Add deterministic branch edge-case fixtures and focused ARM tests</name>
  <files>assets/tests/test_arm_strategies.c
tests/fixtures/manifest.yaml</files>
  <action>Add deterministic ARM fixtures and focused strategy tests for forward/backward/boundary branch rewrite cases, including expected safe-decline behavior where applicable.</action>
  <verify><automated>rg -n "branch|fixture_id|arm|offset|conditional" tests/fixtures/manifest.yaml assets/tests/test_arm_strategies.c</automated></verify>
  <done>Branch offset safety behavior is covered by deterministic fixtures and focused ARM tests.</done>
</task>

</tasks>

<verification>
Validate that covered ARM branch rewrites preserve target/fall-through semantics after expansion and that branch edge-case coverage is deterministic and reproducible.
</verification>

<success_criteria>
- Branch helper coverage enforces bounded offset behavior
- ARM branch rewrite strategies preserve control-flow semantics for covered cases
- Unsafe/unsupported branch forms decline deterministically
- Deterministic branch edge-case fixtures/tests provide ARM-03 evidence
</success_criteria>

<output>
After completion, create `.planning/phases/04-arm-diagnostic-safety-nets/04-01-SUMMARY.md`
</output>
