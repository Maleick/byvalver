---
phase: 01-ci-foundation-and-fixture-canonicalization
plan: "02"
type: execute
wave: 2
depends_on:
  - "01"
files_modified:
  - tests/run_tests.sh
  - .github/workflows/ci.yml
autonomous: true
requirements:
  - TEST-01
  - TEST-02
must_haves:
    truths:
      - Every PR and main push runs baseline build plus smoke checks.
      - Baseline checks execute per architecture and expose all architecture outcomes in one run.
      - Docs-only changes can bypass baseline execution via workflow path filters.
    artifacts:
      - path: tests/run_tests.sh
        provides: Deterministic baseline runner with architecture selection
      - path: .github/workflows/ci.yml
        provides: Architecture-aware baseline CI workflow
    key_links:
      - from: .github/workflows/ci.yml
        to: tests/run_tests.sh
        via: workflow executes runner in baseline mode with matrix arch input
        pattern: --mode baseline --arch
      - from: .github/workflows/ci.yml
        to: tests/run_tests.sh
        via: matrix arch value is forwarded to runner and fail-late matrix preserves full result surface
        pattern: matrix.arch
---

<objective>
Wire canonical fixtures into the baseline CI gate so PRs and main pushes always run deterministic build + smoke checks with full architecture result visibility.

Purpose: satisfy TEST-01 while honoring phase context decisions on matrix behavior and docs-only bypass.
Output: updated baseline runner interface and CI workflow matrix configuration.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ci-foundation-and-fixture-canonicalization/01-CONTEXT.md
@.planning/phases/01-ci-foundation-and-fixture-canonicalization/01-RESEARCH.md
@.planning/phases/01-ci-foundation-and-fixture-canonicalization/01-01-PLAN.md
@tests/run_tests.sh
@.github/workflows/ci.yml

Plan dependency:
- Uses fixture taxonomy from plan 01
- Must preserve CI-on-PR/main behavior
- Must fail at end with full architecture result surface
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add baseline-mode architecture controls to test runner</name>
  <files>tests/run_tests.sh</files>
  <action>Extend `tests/run_tests.sh` with explicit CLI flags for baseline execution: `--arch` (`x86|x64|arm|all`), `--mode baseline`, and optional `--verbose`. Ensure architecture-scoped fixture loops only evaluate the requested architecture set and emit deterministic non-interactive summaries for CI consumption. In baseline mode, treat missing expected fixture sets as failures for requested architectures instead of silent skips.</action>
  <verify><automated>bash -n tests/run_tests.sh && rg -n -- "--arch|--mode|--verbose|baseline" tests/run_tests.sh</automated></verify>
  <done>Runner supports architecture-targeted baseline invocation and returns stable exit behavior suitable for matrix CI jobs.</done>
</task>

<task type="auto">
  <name>Task 2: Convert CI job to fail-late architecture matrix</name>
  <files>.github/workflows/ci.yml</files>
  <action>Update `.github/workflows/ci.yml` to keep baseline checks on all PRs and main pushes while adding docs-only bypass via `paths-ignore`. Introduce an architecture matrix (`x86`, `x64`, `arm`) with `fail-fast: false`. Each matrix entry must run dependency checks, build, executable smoke checks, and `bash tests/run_tests.sh --mode baseline --arch ${{ matrix.arch }}`.</action>
  <verify><automated>rg -n "pull_request|push|paths-ignore|matrix|arch: \\[x86, x64, arm\\]|fail-fast: false|--mode baseline --arch" .github/workflows/ci.yml</automated></verify>
  <done>CI executes baseline checks per architecture without cancelling remaining architectures after the first failure.</done>
</task>

<task type="auto">
  <name>Task 3: Add complete result surface and artifacts per architecture</name>
  <files>.github/workflows/ci.yml</files>
  <action>Publish per-architecture logs/artifacts and add a final summary gate job that always runs after matrix completion to show all architecture outcomes in one place. The final gate should fail if any architecture failed, but only after collecting full result data.</action>
  <verify><automated>rg -n "upload-artifact|if: always\\(\\)|needs:|summary|matrix\\.arch" .github/workflows/ci.yml</automated></verify>
  <done>Each CI run includes complete per-architecture evidence and a single final pass/fail gate reflecting aggregated matrix status.</done>
</task>

</tasks>

<verification>
Validate CI workflow syntax and ensure matrix baseline commands and fail-late semantics are present.
</verification>

<success_criteria>
- Runner accepts `--mode baseline --arch ...` and optional `--verbose`
- CI remains active for PR/main, with docs-only bypass path filters
- Matrix covers `x86`, `x64`, `arm` with `fail-fast: false`
- CI stores per-architecture artifacts and exposes a final aggregate status gate
</success_criteria>

<output>
After completion, create `.planning/phases/01-ci-foundation-and-fixture-canonicalization/01-02-SUMMARY.md`
</output>
